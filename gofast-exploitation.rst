Exploitation GoFast
*******************


+--------+------------------------------------------------------+
| V1.0   | - Version initiale                                   |
+========+======================================================+
| V1.1   | - Ajout d'une partie détaillée sur les sauvegardes   |
+--------+------------------------------------------------------+
| V1.2   | - Ajout de la structure des répertoires (annexe 1)   |
+--------+------------------------------------------------------+

--------------

--------------

--------------

.. contents::

VM 1
====

Processus
---------

La plateforme GoFast est un ensemble technologique dont les principaux
composants sont les suivants :

A noter que l’ensemble de ces services sont configurés pour démarrer
automatiquement lors du boot du serveur. Pour cela la ligne ``/opt/ceo-vision/startup.sh``
a été ajoutée dans le fichier ``/etc/rc.local``::
   [root@gofast ~]# htop
    Mem[|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||11.0G/11.6G] Tasks: 94, 386 thr, 100 kthr; 1 running
    Swp[||||||||||||||||||||||||||||||||||||||                                       1.63G/3.87G] Load average: 1.29 0.94 0.55
                                                                                              Uptime: 123 days(!), 01:52:21
    PID USER      PRI  NI  VIRT   RES   SHR S CPU% MEM%   TIME+  Command
      1 root       20   0  189M  3016  1476 S  0.0  0.0  1h26:52 /usr/lib/systemd/systemd --switched-root --system --deserialize 21
  31997 root       20   0 6642M  947M    76 S  0.7  8.0  1h56:44 ├+ java -server -Xms1G -Xmx1G -XX:NewRatio=3 -XX:SurvivorRatio=4 -XX:TargetSurvivorRatio=90 -XX:MaxTenuringThreshold=8 -XX:+Us
  30805 root       20   0  183M     0     0 S  0.0  0.0  0:01.07 ├+ /usr/bin/newrelic-daemon --agent --pidfile /var/run/newrelic-daemon.pid --logfile /var/log/newrelic/newrelic-daemon.log --p
  30797 root       20   0  488M 13692  8040 S  0.0  0.1  1:45.00 ├+ php-fpm: master process (/etc/php-fpm.conf)
  29617 davfs2     20   0  184M  6700   460 S  0.0  0.1 11:08.05 ├─ mount.davfs -o rw uid=admin localhost:8080/alfresco/webdav /mnt/alfresco_webdav/
  27323 root       20   0  288M   216   204 S  0.0  0.0  0:03.93 ├+ /opt/libreoffice5.3/program/oosplash --accept=socket,host=127.0.0.1,port=8100;urp;StarOffice.ServiceManager -env:UserInstal
  20621 ldap       20   0 1648M  114M  9912 S 13.3  1.0  7h33:29 ├+ /usr/sbin/slapd -u ldap -h ldapi:/// ldaps:/// ldap:///
  16905 root       20   0  249M  2524   672 S  0.0  0.0  1:57.46 ├+ /usr/sbin/httpd -DFOREGROUND
  16859 mysql      20   0 3820M 1514M  1392 S 15.3 12.8 12h00:35 ├+ /usr/sbin/mysqld --daemonize --pid-file=/var/run/mysqld/mysqld.pid
  15833 tomcat     20   0 9694M 3693M  1708 S 16.0 31.2  3h16:35 ├+ /usr/lib/jvm/jre/bin/java -server -Xss1024K -Xms2G -Xmx4G -XX:MaxPermSize=512M -XX:NewSize=1G -XX:-DisableExplicitGC -XX:+U
  14933 tomcat     20   0 7889M 1082M  1868 S  0.7  9.1  1h06:36 ├+ /usr/lib/jvm/jre/bin/java -server -Xss1024K -Xms1G -Xmx3G -XX:MaxPermSize=512M -XX:NewSize=512m -XX:+UseConcMarkSweepGC -XX
  14567 root       20   0  123M   420   312 S  0.0  0.0  2:23.65 ├+ /usr/sbin/crond -n
  10356 chrony     20   0   98M   692   484 S  0.0  0.0  0:22.64 ├─ /usr/sbin/chronyd
   6389 newrelic   20   0 16896     4     0 S  0.0  0.0  0:00.00 ├+ /usr/sbin/nrsysmond -c /etc/newrelic/nrsysmond.cfg -p /var/run/newrelic/nrsysmond.pid
   2633 root       20   0 89892   168    84 S  0.0  0.0  9:33.71 ├+ /usr/libexec/postfix/master -w
   2521 memcached  20   0  626M  256M   108 S  0.0  2.2  9h21:36 ├+ /usr/bin/memcached -u memcached -p 11211 -m 512 -c 1024
   1027 root       20   0  540M   536   156 S  0.0  0.0 16:20.33 ├+ /usr/bin/python -Es /usr/sbin/tuned -l -P
   1025 root       20   0  103M   340   224 S  0.0  0.0 10:52.29 ├+ /usr/sbin/sshd -D
   1012 root       20   0  644M  7612  7016 S  0.0  0.1  3h18:30 ├+ /usr/sbin/rsyslogd -n
    741 root       20   0  427M  1380   636 S  0.0  0.0  8:06.11 ├+ /usr/sbin/NetworkManager --no-daemon
    726 root       20   0  323M  1732   612 S  0.0  0.0  7:58.52 ├+ /usr/bin/python -Es /usr/sbin/firewalld --nofork --nopid
    712 root       20   0  107M     8     4 S  0.0  0.0  0:00.01 ├─ /sbin/agetty --noclear tty1 linux
    703 root       20   0 24324   972   772 S  0.0  0.0 28:54.14 ├─ /usr/lib/systemd/systemd-logind
    696 dbus       20   0 98480   836   384 S  0.0  0.0 49:38.94 ├+ /bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation
    695 root       20   0  396M  2520  1144 S  0.0  0.0  2h13:27 ├+ /usr/bin/vmtoolsd
    693 root       20   0 19320   396   260 S  0.0  0.0 29:34.11 ├─ /usr/sbin/irqbalance --foreground
    685 polkitd    20   0  515M  1224   536 S  0.0  0.0 12:32.97 ├+ /usr/lib/polkit-1/polkitd --no-debug
    668 root       16  -4 55416   268   160 S  0.0  0.0  9:22.34 ├+ /sbin/auditd -n
    539 root       20   0 47372   368   268 S  0.0  0.0  0:02.01 ├─ /usr/lib/systemd/systemd-udevd
    533 root       20   0  198M     0     0 S  0.0  0.0  0:00.03 ├─ /usr/sbin/lvmetad -f
    511 root       20   0 46612  9692  9288 S  1.3  0.1  6h20:14 └─ /usr/lib/systemd/systemd-journald
      2 root       20   0     0     0     0 S  0.0  0.0  0:12.51 kthreadd
  30429 root       20   0     0     0     0 D  0.7  0.0  0:01.43 ├─ kworker/u12:0
  29534 root        0 -20     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/0:1H
  29141 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/2:1
  29139 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/u12:2
  28808 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/1:2
  28806 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/0:2
  28263 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/3:0
  27999 root       20   0     0     0     0 S  0.0  0.0  0:00.16 ├─ kworker/4:0
  27003 root       20   0     0     0     0 S  0.0  0.0  0:00.00 ├─ kworker/3:1

Serveur Web Apache
^^^^^^^^^^^^^^^^^^

Afin que la partie «Portail » de GoFast, qui est basésur une technologie
PHP (php-fpm) et notamment le CMS Drupal, puisse fonctionner, il fautqu’elle soit
hébergée sur un serveur Apache

En production, de nombreux processus sont créés afin derépondre à
chacune des requêtes http effectuées par les clients. Ces processussont
nommés «/usr/sbin/httpd »

.. figure:: img/exploit/clip_image002.jpg
   :alt: 

 
~

Serveurs Web Tomcat
^^^^^^^^^^^^^^^^^^

La partie «Entrepôt documentaire » est assurée par lelogiciel Alfresco,
qui est une application développée en Java, ce qui nécessiteun serveur
web Tomcat pour fonctionner.

De même la partie «Gestion de processus » est assuréepar le logiciel
Bonitasoft, qui est une application développée en Java, ce quinécessite
également un serveur web Tomcat pour fonctionner

.. figure:: img/exploit/clip_image004.jpg
   :alt: 

 
~

Base de données MySQL
^^^^^^^^^^^^^^^^^^

Les deux composants précédents (Drupal et Alfresco)nécessitent chacun de
posséder une base de données permettant leur bonfonctionnement.

Ces bases de données sont hébergées par MySQL.

La base de données utilisée par Drupal possède le nom«drupal »

La base de données utilisée par Alfresco se nomme« alfresco »

En production, cela se traduit par deuxprocessus :

1)

# /bin/sh/usr/bin/mysqld\_safe –datadir=/var/lib/mysql
--socket=/var/lib/mysql/mysql.sock--pid-file=/var/run/mysqld/mysqld.pid
--basedir=/usr --user=mysql

2)

# /usr/libexec/mysqld--basedir=/usr --datadir=/var/lib/mysql
--plugin-dir=/usr/lib64/mysql/plugin--user=mysql
--log-error=/var/log/mysqld.log--pid-file=/var/run/mysqld/mysqld.pid
--socket=/var/lib/mysql/mysql.sock

.. figure:: img/exploit/clip_image006.jpg
   :alt: 

Moteur de recherche Solr
^^^^^^^^^^^^^^^^^^

L’indexation et la recherche au sein de la plateformeGoFast sont
assurées par Apache Solr.

En production, cela se traduit par un processus qui senomme «java –jar
start.jar »

.. figure:: img/exploit/clip_image008.jpg
   :alt: 

Serveur LDAP
^^^^^^^^^^^^^^^^^^

Les différents Utilisateurs et Espaces collaboratifs de laplateforme
GoFast sont stockés au sein d’un annuaire LDAP, utilisé par
lesdifférents composants de la plateforme.

En production, cela se traduit par un processus « /usr/sbin/slapd »

.. figure:: img/exploit/clip_image010.jpg
   :alt: 

Composant de prévisualisation de documents
^^^^^^^^^^^^^^^^^^

Tous les documents (compatibles) stockés dans laplateforme GoFast
possèdent une prévisualisation au format PDF.

Cette transformation est assurée par le logicielLibreOffice.

En production cela setraduit par un processus nommé
/opt/libreoffice4.1/program/soffice.bin

+----+------------+
+====+============+
|    | |image0|   |
+----+------------+

Supervision
-----------

 
VM 2
====


Monitoringdu serveur
--------------------

Chez tous nos clients, nous installons automatiquement uncomposant
chargé de monitorer les informations principales du serveur.

Ce composant est « Newrelic »
(`https://newrelic.com/ <smb://newrelic.com/>`__)

Les principales informations supervisées sont lessuivantes :

-  Charge CPU

-  Disk IO

-  Utilisation RAM

-  Place disque disponible

-  Utilisation Réseau

En production, cela setraduit par deux processus « /usr/sbin/nrsysmond
»qui effectuent des requêtes vers internet toutes les 3 minutes.

.. figure:: img/exploit/clip_image014.jpg
   :alt: 

.. figure:: img/exploit/clip_image016.jpg
   :alt: 

--------------

Sécurisation des données (sauvegarde, DR,...)
=============================================

La plateforme GoFAST regroupe le contenu stratégique del'organisation.
La sécurité des données doit s'appuyer sur une couche'architecture'
(RAID+SAN double ou clustering) doublée d'une stratégie
desauvegarde.\ ****

**La sauvegarde est donc primordiale de même que lestests de
restauration. **

La question de la perte admissible doit être posée, toutcomme le délai
de restauration. Ceci permet de déterminer une stratégie desauvegarde.

**A) Sauvegarde distante de la plateforme dans sonintégralité : **

- Par snapshot de VM\ ****

--------------

**B) Sauvegardedistante des données uniquement : **

- Par sauvegarde des donnéesapplicatives

- Par réplication totale desdonnées sur un serveur distant (Disaster
Recovery)

- Par sauvegarde des fichiersuniquement

Sauvegarde par snapshot de VM
-----------------------------

Dans ce cas, l’ensemble de la machine virtuelle estsauvegardée.

Il est recommandé de faire un snapshot quotidien de la VMest dehors des
heures d’activité car il y a un impact sur les
performances(entrées/sorties ou I/O). De plus afin d’assurer l’intégrité
du snapshotl'application peut devoir ‘geler’ la VM pendant un certain
temps, ceci étantdépendant des technologies utilisées.\ ****

**Lorsque CEO-Visionfournit l'hébergement auprès d'un de ses
partenaires, ce type de sauvegarde estautomatiquement incluse.**

 
-

`Sauvegarde desdonnées applicatives <>`__
-----------------------------------------

Une fois par jour à 23h31, toutes les informationsnécessaires au
fonctionnement de la plateforme GoFast sont sauvegardées dans
unrépertoire local.

Pour cela, en utilisant le mécanisme de « cron »Linux, la commande «
/usr/bin/rsnapshotdaily » est exécutée une fois par jour. Ce mécanisme
appel unscript de backup crée par CEO-Vision
(/opt/ceo-vision/backup.sh)qui enregistre les données nécessaires dans
le dossier **/var/backup**

Si une durée de rétention est mise en place, il estpossible de retrouver
les données de 1 ou plusieurs jours auparavant dans cedossier
/var/backup

Les données sauvegardées sont les suivantes :

-  la base Mysql drupal

-  la base Mysql alfresco

-  l’’annuaire ldap

-  les fichiers de l’entrepôt documentaire

-  les sources Drupal

**Il est fortement recommandé àl’infogérant de monter /var/backup sur un
stockage distant\***\ \*\*\*

--------------

**A l'heure actuelle, l'index (Apache Solr) n'est passauvegardé**

`ANNEXE 1 <>`__ : Arborescence GoFAST
=====================================

+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
| /opt/ceo-vision/                                                                                       | Application & Scripts CEO-Vision/GoFAST          |
+========================================================================================================+==================================================+
| /opt/bonita /opt/libreoffice4.2 /opt/solr /opt/alfresco                                                | Applications                                     |
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
| /var/backup                                                                                            | Espace de sauvegarde (mysql,openldap,alfresco)   |
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
| /var/lib/mysql /var/lib/ldap /var/www/drupal /var/alfresco                                             | Données des applications                         |
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
| /etc/openldap /etc/httpd /etc/extra/browscap.ini /etc/php.ini /etc/my.cnf /etc/crontab /etc/newrelic   | Fichiers de configuration                        |
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
| /etc/pki                                                                                               | Certificats                                      |
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+
+--------------------------------------------------------------------------------------------------------+--------------------------------------------------+

 
-

`ANNEXE II: Sauvegarde par vacations desdonnées sur un serveur distant (Disaster Recovery « Minimal») <>`__
===========================================================================================================

\*Nb : Ceci est une extension (option) de l'abonnement GoFAST, couvrant
la mise à jour d’un environnement supplémentaire.\*

Dans ce cas de DR Minimal, le principe est de remonter lessauvegardes
crées par les scripts GoFAST (voir “Sauvegarde des
donnéesapplicatives”), dans un environnement distant dit de stand-by.

La machine de ‘standby’ est une installation GoFAST en tant que telle.
Lors des mises à jour de l’environnement de production, l’environnement
de DR est mis à jour par CEO-Vision.

**Nb :Afin de garantir l’intégrité d’Alfresco sur le DR, la date des
fichierssauvegardés doit correspondre à la date du snapshot de la base
de données. Ceciest garantie par le script livré avec la plateforme
GoFAST**

-  \*

\*\*Cas 1) La sauvegarde à distance d’Alfresco est faite dans
/var/backup \*\*

n Importde la base de données

n Copiede /var/backup/...alfresco dans /var/alfresco

n Chargementde la partie LDAP

**Cas 2) Lasauvegarde à distance d’Alfresco est faite directement dans
le répertoire/var/alfresco**

n Importde la base de données

n Chargementde la partie LDAP

 
-

`ANNEXE III : Duplication distante des fichiers <>`__
=====================================================

Il peut être souhaité de sauvegarder sur un autre serveurune simple
copie des fichiers de l'entrepôt. ****

**Nb : Dans ce cas seul la dernière versiondes fichiers est sauvegardée.
Les méta-données ou commentaires ne sont passauvegardés.**

**1) Méthode 1 : Lecteur Réseau**

La 1ère méthode est d'utiliser un logiciel de sauvegardesur le serveur
destiné à stocker les sauvegardes. Ce logiciel de sauvegardedoit pouvoir
sauvegarder un «lecteur réseau » ou directement un serveurWebdav. Afin
de limiter la bande passante utilisée et les ressources machinesil est
préférables de faire des sauvegardes incrémentales ou différentielles.

Le « lecteur réseau » possède l'adresse suivante:


`https://\ **url\_de\_la\_gofast**/alfresco/webdav <smb://url_de_la_gofast/alfresco/webdav>`__

 par exemple :
`https://gofast.ceo-vision.com/alfresco/webdav <../webdav>`__

Bien sûr l'identifiant doit être l'utilisateur **'adm'** qui est le seul
utilisateur ayant l'accès à tous les documents de la plate-forme.

